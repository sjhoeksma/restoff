(function(){"use strict";function e(e){var i=Object.create(t.prototype);return i._isOnline=null,i._forcedOffline=!1,i._persistanceDisabled=void 0!==e&&e.persistanceDisabled?e.persistanceDisabled:!1,i._persistanceDisabled?i._dbRepo=null:i._dbRepo=void 0!==e&&e.dbRepo?e.dbRepo:r(),i._autoParams={},i._autoHeaders={},i._pending=[],i._rootUri=void 0!==e&&e.rootUri?e.rootUri:"",i._primaryKeyName=void 0!==e&&e.primaryKeyName?e.primaryKeyName:"id",i}function t(){}function r(e){var t=Object.create(i.prototype);return t._dbName=void 0!==e&&e.dbName?e.dbName:"restoff",t._low=low(t._dbName,{storage:low.localStorage}),t}function i(){}var n=this,o=n.restlib||{};o["version-library"]="0.0.22","undefined"!=typeof module&&module.exports?module.exports=o:n.restlib=o,t.prototype=Object.create(Object.prototype,{dbRepo:{get:function(){return this._dbRepo}},pending:{get:function(){return this._pending}},isStatusOnline:{get:function(){return this._isOnline===!0}},isStatusOffline:{get:function(){return this._isOnline===!1}},isStatusUnknown:{get:function(){return null===this._isOnline}},isForcedOffline:{get:function(){return this._forcedOffline}},persistanceDisabled:{get:function(){return this._persistanceDisabled},set:function(e){this._persistanceDisabled=e,this._dbRepo=e?null:r()}},primaryKeyName:{get:function(){return this._primaryKeyName},set:function(e){this._primaryKeyName=e}},rootUri:{get:function(){return this._rootUri},set:function(e){this._rootUri=e}},getRequest:{get:function(){var e=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");return this.isForcedOffline?(e.__defineGetter__("readyState2",function(){return e.__proto__.DONE}),e.send=function(){this.onreadystatechange()}):e.__defineGetter__("readyState2",function(){return this.readyState}),e}},deleteSomeTime:{get:function(){return this._isOnline===!0}}}),t.prototype.uriGenerate=function(e){var t=e;-1===t.indexOf("http")&&(t=this.rootUri+t);var r=this._autoParams,i=Object.keys(r);if(i.length>0){var n=!0;-1!==t.indexOf("?")?n=!1:t+="?",i.forEach(function(e){t+=(n?"":"&")+e+"="+r[e],n=!1})}return t},t.prototype.uriRec=function(e,t,r){var i={uriOriginal:e,primaryKey:"",uriFinal:this.uriGenerate(e),primaryKeyName:this.primaryKeyName,restMethod:t,resources:r},n=e.replace(this.rootUri,""),o=n.split("?");o.length>1&&(n=o[0],i.search=o[1]);var s=n.split("/");return s.length>1&&(n=s[0],i.primaryKey=s[1]),""===i.primaryKey&&void 0!==r&&null!==r&&void 0!==r[this.primaryKeyName]&&(i.primaryKey=r[this.primaryKeyName]),i.repoName=n,i},t.prototype.primaryKeyFor=function(e){var t=e[this.primaryKeyName];return void 0===e[this.primaryKeyName]&&console.log("Warning: resource %O did not have a primaryKey ",e),t},t.prototype.clearAll=function(e){if(e=void 0===e?!1:e,this.pending.length>0&&!1===e)throw new Error("Submit pending changes before clearing database or call clearAll(true) to force.");this._dbRepo.clearAll(),this._pending=[]},t.prototype.clear=function(e,t){if(t=void 0===t?!1:t,this.pending.length>0&&!1===t)throw new Error("Submit pending changes before clearing database or call clear(repoName, true) to force.");this._dbRepo.clear(e),this._pending.forEach(function(t,r,i){e===t.repoName&&i.splice(r,1)})},t.prototype.forceOffline=function(e){return this._forcedOffline=!0,this._isOnline=null,this},t.prototype.repoGet=function(e){var t;return""!==e.primaryKey&&(t={},t[e.primaryKeyName]=e.primaryKey),this.persistanceDisabled?[]:this.dbRepo.read(e.repoName,t)},t.prototype.repoFind=function(e){return this._dbRepo.find(e.repoName,e.primaryKeyName,e.primaryKey)},t.prototype.repoAdd=function(e,t){return e.resources=JSON.parse(t),this.repoAddResource(e)},t.prototype.repoAddResource=function(e){var t=e.resources instanceof Array?e.resources:[e.resources];if(!this.persistanceDisabled){var r=this;""===e.primaryKey&&"GET"===e.restMethod&&this.clear(e.repoName),t.forEach(function(t){var i=r.primaryKeyFor(t);r.dbRepo.write(e.repoName,r.primaryKeyName,i,t)})}return e.resources},t.prototype.repoDeleteResource=function(e){this.persistanceDisabled||this.dbRepo["delete"](e.repoName,e.primaryKeyName,e.primaryKey)},t.prototype.createError=function(e,t,r,i){var n=e.replace(/\r?\n|\r/g,"");return 0===r&&(i="Network Error"),{message:i,messageDetail:n,status:r,uri:t}},t.prototype.autoQueryParamSet=function(e,t){return this._autoParams[e]=t,this},t.prototype.autoQueryParamGet=function(e){return this._autoParams[e]},t.prototype.autoHeaderParamSet=function(e,t){return this._autoHeaders[e]=t,this},t.prototype.autoHeaderParamGet=function(e){return this._autoHeaders[e]},t.prototype.pendingAdd=function(e){var t={restMethod:e.restMethod,resources:e.resources,clientTime:new Date,uri:e.uriFinal,repoName:e.repoName};return this._pending.push(t),t},t.prototype._dbDelete=function(e,t,r,i){t.__proto__.DONE===t.readyState2&&(t.__proto__.UNSENT===t.status&&this.isForcedOffline?(this._isOnline=!1,this.pendingAdd(e),this.repoDeleteResource(e),r()):200===t.status?(this._isOnline=!0,this.repoDeleteResource(e),r()):404===t.status?(this._isOnline=!0,this.repoDeleteResource(e),r()):(this._isOnline=0!==t.status?!0:null,i(this.createError(t.responseText,e.uriFinal,t.status,t.message))))},t.prototype._dbGet=function(e,t,r,i){var t=e.request;4===t.readyState&&(0===t.status&&this.isForcedOffline?(this._isOnline=!1,r(this.repoGet(e))):200===t.status?(this._isOnline=!0,r(this.repoAdd(e,t.response))):(this._isOnline=0!==t.status?!0:null,i(this.createError(e.request.responseText,e.uriFinal,t.status,t.statusText))))},t.prototype._dbPost=function(e,t,r,i){t.__proto__.DONE===t.readyState2&&(t.__proto__.UNSENT===t.status&&this.isForcedOffline?(this._isOnline=!1,this.pendingAdd(e),r(this.repoAddResource(e))):201===t.status?(this._isOnline=!0,r(this.repoAddResource(e))):(this._isOnline=0!==t.status?!0:null,i(this.createError(t.responseText,e.uriFinal,t.status,t.statusText))))},t.prototype._dbPut=function(e,t,r,i){if(t.__proto__.DONE===t.readyState2)if(200===t.status)this._isOnline=!0,r(this.repoAddResource(e));else{var n=t.status,o=t.statusText;this._isOnline=0!==t.status?!0:null,this.isForcedOffline?(this._isOnline=!1,this.repoFind(e)?(this.pendingAdd(e),r(this.repoAddResource(e))):(n=404,o="Not Found",i(this.createError(t.responseText,e.uriFinal,n,o)))):(this._isOnline=0!==t.status?!0:null,i(this.createError(t.responseText,e.uriFinal,t.status,t.statusText)))}},t.prototype["delete"]=function(e){var t=this,r=new Promise(function(r,i){var n=t.getRequest,o=t.uriRec(e,"DELETE");n.open("DELETE",o.uriFinal,!0),n.onreadystatechange=function(){t._dbDelete(o,n,r,i)},n.send()});return r},t.prototype._requestHeaderSet=function(e){var t=this._autoHeaders;Object.keys(t).forEach(function(r){e.setRequestHeader(r,t[r])})},t.prototype.get=function(e){var t=this,r=new Promise(function(r,i){var n=t.getRequest,o=t.uriRec(e,"GET");n.open("GET",o.uriFinal,!0),t._requestHeaderSet(n),n.onreadystatechange=function(){o.request={readyState:n.readyState2,status:n.status,statusText:n.statusText,response:n.response,responseText:n.responseText},t._dbGet(o,n,r,i)},n.send()});return r},t.prototype.post=function(e,t){var r=this,i=new Promise(function(i,n){var o=r.getRequest,s=r.uriRec(e,"POST",t),a=JSON.stringify(t);o.open("POST",s.uriFinal,!0),o.onreadystatechange=function(){r._dbPost(s,o,i,n)},o.setRequestHeader("Content-Type","application/json;charset=UTF-8"),o.send(a)});return i},t.prototype.put=function(e,t){var r=this,i=new Promise(function(i,n){var o=r.getRequest,s=r.uriRec(e,"PUT",t),a=JSON.stringify(t);o.open("PUT",s.uriFinal,!0),o.onreadystatechange=function(){r._dbPut(s,o,i,n)},o.setRequestHeader("Content-Type","application/json;charset=UTF-8"),o.send(a)});return i},o.restoff=e,i.prototype=Object.create(Object.prototype,{dbName:{get:function(){return this._dbName},set:function(e){this._dbName=e}},dbEngine:{get:function(){return this._low}},deleteSomeTime:{get:function(){return this._isOnline===!0}}}),o.lowdbRepo=r,i.prototype.length=function(e){return this._low(e).size()},i.prototype.clear=function(e){delete this._low.object[e],this._low.write()},i.prototype.clearAll=function(){this._low.object={},this._low.write()},i.prototype.find=function(e,t,r){var i={};return i[t]=r,this._low(e).find(i)},i.prototype.read=function(e,t){return void 0!==t&&null!==t?this._low(e).find(t):this._low(e).value()},i.prototype.write=function(e,t,r,i){if(void 0===this.find(e,t,r))this._low(e).push(i);else{var n={};n[t]=r,this.dbEngine(e).chain().find(n).assign(i).value()}},i.prototype["delete"]=function(e,t,r){var i={};return i[t]=r,this._low(e).remove(i)}}).call(this);