(function(){"use strict";function e(e){var n={primaryKeyName:"id",rootUri:"",clientOnly:!1,forcedOffline:!1,persistanceDisabled:!1,pendingUri:"http://localhost/"},o=Object.create(t.prototype);return o._options=Object.assign(n,e),o._isOnline=null,o._pending=[],o._autoParams={},o._autoHeaders={},o._options.persistanceDisabled?o._dbRepo=null:o._dbRepo=void 0!==e&&e.dbRepo?e.dbRepo:r(),o}function t(){}function r(e){var t=Object.create(n.prototype);return t._dbName=void 0!==e&&e.dbName?e.dbName:"restoff",t._low=low(t._dbName,{storage:low.localStorage}),t}function n(){}var o=this,i=o.restlib||{};i["version-library"]="0.1.1","undefined"!=typeof module&&module.exports?module.exports=i:o.restlib=i,t.prototype=Object.create(Object.prototype,{dbRepo:{get:function(){return this._dbRepo}},pending:{get:function(){return this._pending}},isStatusOnline:{get:function(){return this._isOnline===!0}},isStatusOffline:{get:function(){return this._isOnline===!1}},isStatusUnknown:{get:function(){return null===this._isOnline}},forcedOffline:{get:function(){return this._options.forcedOffline},set:function(e){this._options.forcedOffline=e,this._isOnline=null}},clientOnly:{get:function(){return this._options.clientOnly},set:function(e){this._options.clientOnly=e}},pendingUri:{get:function(){return this._options.pendingUri}},persistanceDisabled:{get:function(){return this._options.persistanceDisabled},set:function(e){this._options.persistanceDisabled=e,this._dbRepo=e?null:r()}},primaryKeyName:{get:function(){return this._options.primaryKeyName},set:function(e){this._options.primaryKeyName=e}},rootUri:{get:function(){return this._options.rootUri},set:function(e){this._options.rootUri=e}},options:{get:function(){return this._options}}}),t.prototype._logMessage=function(e){console.log(e)},t.prototype._pendingWrite=function(e){var t=this,r=new Promise(function(r,n){r(t._pending.push(e))});return r},t.prototype._pendingLength=function(e){var t=this,r=new Promise(function(e,r){e(t.pending.length)});return r},t.prototype._pendingClear=function(e){var t=this;return new Promise(function(r,n){t._pending.forEach(function(t,r,n){e===t.repoName&&n.splice(r,1)}),r()})},t.prototype._pendingClearAll=function(){var e=this;return new Promise(function(t,r){e._pending=[],t()})},t.prototype._requestGet=function(e){var t=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");return e.options.forcedOffline||e.options.clientOnly?(t.__defineGetter__("readyStateRestOff",function(){return t.__proto__.DONE}),t.send=function(){this.onreadystatechange()}):t.__defineGetter__("readyStateRestOff",function(){return this.readyState}),t},t.prototype._uriGenerate=function(e){var t=e.uri;-1===t.indexOf("http")&&(t=e.options.rootUri+t);var r=this._autoParams,n=Object.keys(r);if(n.length>0){var o=!0;-1!==t.indexOf("?")?o=!1:t+="?",n.forEach(function(e){t+=(o?"":"&")+e+"="+r[e],o=!1})}return t},t.prototype.uriFromClient=function(e,t,r,n){var o={uri:e,primaryKey:"",primaryKeyName:this.primaryKeyName,restMethod:t,resources:r,options:Object.assign({},this._options,n),searchOptions:{}};o.options.rootUri.endsWith("/")||(o.options.rootUri=o.options.rootUri+"/"),o.uriFinal=this._uriGenerate(o);var i=e.replace(o.options.rootUri,""),s=i.split("?");if(s.length>1){var a=this;i=s[0],o.search=s[1],o.search.split("&").forEach(function(e){var t=e.split("=");2===t.length?o.searchOptions[t[0]]=t[1]:a._logMessage("WARNING: Invalid search query.")})}var p=i.split("/");return p.length>1&&(i=p[0],o.primaryKey=p[1]),""===o.primaryKey&&void 0!==r&&null!==r&&void 0!==r[this.primaryKeyName]&&(o.primaryKey=r[this.primaryKeyName]),o.repoName=i,"http:"===o.repoName&&this._logMessage("WARNING: repoName invalid. It could be you are using the wrong rootUri?"),o},t.prototype.primaryKeyFor=function(e){var t=e[this.primaryKeyName];return void 0===e[this.primaryKeyName]&&console.log("Warning: resource %O did not have a primaryKey ",e),t},t.prototype.clearAll=function(e){var t=this;return new Promise(function(r,n){return e=void 0===e?!1:e,t._pendingLength().then(function(o){return o>0&&!1===e?void n("Submit pending changes before clearing database or call clearAll(true) to force."):(t._dbRepo.clearAll(),t._pendingClearAll().then(function(e){r()}))})})},t.prototype.clear=function(e,t){var r=this;return new Promise(function(n,o){return t=void 0===t?!1:t,r._pendingLength(e).then(function(i){return i>0&&!1===t?void o("Submit pending changes before clearing database or call clear(repoName, true) to force."):(r._dbRepo.clear(e),r._pendingClear(e).then(function(e){n()}))})})},t.prototype.repoGet=function(e){var t=e.searchOptions;return""!==e.primaryKey&&(t[e.primaryKeyName]=e.primaryKey),e.options.persistanceDisabled?[]:this.dbRepo.read(e.repoName,t)},t.prototype.repoFind=function(e){return this._dbRepo.find(e.repoName,e.primaryKeyName,e.primaryKey)},t.prototype.repoAdd=function(e,t){var r=this;return new Promise(function(n,o){return e.resources=JSON.parse(t),r.repoAddResource(e).then(function(e){n(e)})})},t.prototype._repoAddAll=function(e,t){var r=this;t.forEach(function(t){var n=r.primaryKeyFor(t);r.dbRepo.write(e.repoName,r.primaryKeyName,n,t)})},t.prototype.repoAddResource=function(e){var t=this;return new Promise(function(r,n){var o=e.resources instanceof Array?e.resources:[e.resources];if(!e.options.persistanceDisabled){if(""===e.primaryKey&&"GET"===e.restMethod)return t.clear(e.repoName).then(function(){t._repoAddAll(e,o),r(e.resources)});t._repoAddAll(e,o)}r(e.resources)})},t.prototype.repoDeleteResource=function(e){if(!e.options.persistanceDisabled){var t=e.searchOptions;""!==e.primaryKey&&(t[e.primaryKeyName]=e.primaryKey),this.dbRepo["delete"](e.repoName,t)}},t.prototype.createError=function(e){var t=e.request,r=t.responseText.replace(/\r?\n|\r/g,""),n=t.statusText;return 0===t.status&&(n="Network Error"),{message:n,messageDetail:r,status:t.status,uri:e.uriFinal}},t.prototype.autoQueryParamSet=function(e,t){return this._autoParams[e]=t,this},t.prototype.autoQueryParamGet=function(e){return this._autoParams[e]},t.prototype.autoHeaderParamSet=function(e,t){return this._autoHeaders[e]=t,this},t.prototype.autoHeaderParamGet=function(e){return this._autoHeaders[e]},t.prototype.pendingAdd=function(e){var t=this;return new Promise(function(r,n){var o={restMethod:e.restMethod,resources:e.resources,clientTime:new Date,uri:e.uriFinal,repoName:e.repoName};e.options.persistanceDisabled||t._pendingWrite(o),r(o)})},t.prototype._requestHeaderSet=function(e){var t=this._autoHeaders;Object.keys(t).forEach(function(r){e.setRequestHeader(r,t[r])})},t.prototype._uriAddRequest=function(e,t){return e.request={readyState:t.readyStateRestOff,status:t.status,statusText:t.statusText,response:t.response,responseText:t.responseText},e},t.prototype._dbDelete=function(e,t,r){var n=e.request;switch(n.status){case 200:case 202:case 204:this._isOnline=!0,this.repoDeleteResource(e),t();break;case 404:this._isOnline=!0,this.repoDeleteResource(e),t();break;case 0:var o=e.options.clientOnly;if(e.options.forcedOffline||o)if(this._isOnline=!1,o)this.repoDeleteResource(e),t();else{var i=this;this.pendingAdd(e).then(function(r){i.repoDeleteResource(e),t()})}else this._isOnline=null,r(this.createError(e));break;default:console.log("WARNING: Unsupported HTTP response.")}},t.prototype._dbGet=function(e,t,r){var n=e.request;switch(n.status){case 200:return this._isOnline=!0,this.repoAdd(e,n.response).then(function(e){t(e)});case 0:case 404:var o=e.options.clientOnly;e.options.forcedOffline||o?(this._isOnline=!1,t(this.repoGet(e))):(this._isOnline=0!==n.status?!0:null,r(this.createError(e)));break;default:console.log("WARNING: Unsupported HTTP response.")}},t.prototype._pendingRepoAdd=function(e,t,r,n){if(t)return this.repoAddResource(e).then(function(e){r(e)});var o=this;return this.pendingAdd(e).then(function(t){return o.repoAddResource(e).then(function(e){r(e)})})},t.prototype._dbPost=function(e,t,r){var n=e.request;switch(n.status){case 201:return this._isOnline=!0,this.repoAddResource(e).then(function(e){t(e)});case 0:case 404:var o=e.options.clientOnly;e.options.forcedOffline||o?(this._isOnline=!1,this._pendingRepoAdd(e,o,t,r)):(this._isOnline=0!==n.status?!0:null,r(this.createError(e)));break;default:console.log("WARNING: Unsupported HTTP response.")}},t.prototype._dbPut=function(e,t,r){var n=e.request;switch(n.status){case 200:this._isOnline=!0,t(this.repoAddResource(e));break;default:n.status,n.statusText;this._isOnline=0!==n.status?!0:null;var o=e.options.clientOnly;e.options.forcedOffline||o?(this._isOnline=!1,this.repoFind(e)?this._pendingRepoAdd(e,o,t,r):(e.request.status=404,e.request.statusText="Not Found",r(this.createError(e)))):(this._isOnline=0!==n.status?!0:null,r(this.createError(e)))}},t.prototype._restCall=function(e,t,r,n){var o=this;return new Promise(function(i,s){var a=o.uriFromClient(e,t,n,r),p=o._requestGet(a),u=JSON.stringify(n);p.open(a.restMethod,a.uriFinal,!0),o._requestHeaderSet(p),p.onreadystatechange=function(){if(4===p.readyStateRestOff)switch(o._uriAddRequest(a,p),a.restMethod){case"GET":o._dbGet(a,i,s);break;case"POST":o._dbPost(a,i,s);break;case"PUT":o._dbPut(a,i,s);break;case"DELETE":o._dbDelete(a,i,s)}},"POST"===a.restMethod||"PUT"===a.restMethod?(p.setRequestHeader("Content-Type","application/json;charset=UTF-8"),p.send(u)):p.send()})},t.prototype["delete"]=function(e,t){return this._restCall(e,"DELETE",t)},t.prototype.get=function(e,t){return this._restCall(e,"GET",t)},t.prototype.post=function(e,t,r){return this._restCall(e,"POST",r,t)},t.prototype.put=function(e,t,r){return this._restCall(e,"PUT",r,t)},i.restoff=e,n.prototype=Object.create(Object.prototype,{dbName:{get:function(){return this._dbName},set:function(e){this._dbName=e}},dbEngine:{get:function(){return this._low}},deleteSomeTime:{get:function(){return this._isOnline===!0}}}),i.lowdbRepo=r,n.prototype.length=function(e){return this._low(e).size()},n.prototype.clear=function(e){delete this._low.object[e],this._low.write()},n.prototype.clearAll=function(){this._low.object={},this._low.write()},n.prototype.find=function(e,t,r){var n={};return n[t]=r,this._low(e).find(n)},n.prototype.read=function(e,t){return this._low(e).chain().filter(t).value()},n.prototype.write=function(e,t,r,n){if(void 0===this.find(e,t,r))this._low(e).push(n);else{var o={};o[t]=r,this.dbEngine(e).chain().find(o).assign(n).value()}},n.prototype["delete"]=function(e,t,r){this._low(e).remove(query)}}).call(this);