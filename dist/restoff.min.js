(function(){"use strict";function e(e){var r={dbName:"restoff.json"},n=Object.create(t.prototype);n._options=Object.assign(r,e);var o=s&&s.low?s.low:void 0;if("undefined"!=typeof module&&module.exports){o=require("lowdb");var i=require("lowdb/file-sync");n._low=o(n.dbName,{storage:i})}else{if("undefined"==typeof o)throw new Error("LowDb library required. Please see README.md on how to get this library.");n._low=o(n.dbName,{storage:o.localStorage})}return n}function t(){}function r(t){var r={primaryKeyName:"id",dbName:"restoff.json",repoOptions:[]},o=Object.create(n.prototype);return o._options=Object.assign(r,t),o._dbRepo=e(o._options),o}function n(){}function o(e){var t={rootUri:"",clientOnly:!1,forcedOffline:!1,persistenceDisabled:!1,pendingUri:"http://localhost/",pendingRepoName:"pending"},n=Object.create(i.prototype);return n._options=Object.assign(t,e),n._options.generateId=e&&e.generateId?e.generateId:n._guidGenerate,n._isOnline=null,n._autoParams={},n._autoHeaders={},n._dbService=r(n._options.dbService),n}function i(){}var s=this,p=s.restlib||{};p["version-library"]="0.2.6","undefined"!=typeof module&&module.exports?module.exports=p:s.restlib=p,t.prototype=Object.create(Object.prototype,{dbName:{get:function(){return this.options.dbName},set:function(e){this.options.dbName=e}},dbEngine:{get:function(){return this._low}},options:{get:function(){return this._options}}}),p.lowdbRepo=e,t.prototype.length=function(e){return this._low(e).size()},t.prototype.clear=function(e){delete this._low.object[e],this._low.write()},t.prototype.clearAll=function(){this._low.object={},this._low.write()},t.prototype.find=function(e,t,r){var n={};return n[t]=r,this._low(e).find(n)},t.prototype.read=function(e,t){return this._low(e).chain().filter(t).value()},t.prototype.write=function(e,t,r){var n=r[t];if(void 0===this.find(e,t,n))this._low(e).push(r);else{var o={};o[t]=n,this.dbEngine(e).chain().find(o).assign(r).value()}},t.prototype["delete"]=function(e,t){this._low(e).remove(t)},n.prototype=Object.create(Object.prototype,{dbName:{get:function(){return this.options.dbName},set:function(e){this.options.dbName=e}},dbRepo:{get:function(){return this._dbRepo}},options:{get:function(){return this._options}},primaryKeyName:{get:function(){return this.options.primaryKeyName},set:function(e){this.options.primaryKeyName=e}}}),n.prototype.pkNameGet=function(e,t){var r=this.primaryKeyName,n=this.repoOptionsGet(e);return void 0!==n&&(r=n.primaryKeyName),void 0!==t&&void 0!==t.primaryKeyName&&(r=t.primaryKeyName),r},n.prototype.repoOptionsGet=function(e){var t=void 0;return this.options.repoOptions.forEach(function(r){r.repoName===e&&(t=r)}),t},n.prototype.repoOptionsSet=function(e){var t=this;return this.options.repoOptions.forEach(function(r,n){r.repoName===e.repoName&&t.options.repoOptions.splice(n,1)}),this.options.repoOptions.push(e),this},n.prototype.clearNp=function(e){return this.dbRepo.clear(e)},n.prototype.clearAllNp=function(){return this.dbRepo.clearAll()},n.prototype.deleteNp=function(e,t){return this.dbRepo["delete"](e,t)},n.prototype.findNp=function(e,t){return this.dbRepo.read(e,t)},n.prototype.writeNp=function(e,t,r){var n=this.pkNameGet(e,r);t=t instanceof Array?t:[t],t.forEach(function(e){var t=e[n];if(void 0===t)throw new Error("Primary key '"+n+"' missing for resource or the resource has an invalid primary key.")});var o=this;return t.forEach(function(t){o.dbRepo.write(e,n,t)}),t},p.restoffService=r,i.prototype=Object.create(Object.prototype,{dbService:{get:function(){return this._dbService}},isStatusOnline:{get:function(){return this._isOnline===!0}},isStatusOffline:{get:function(){return this._isOnline===!1}},isStatusUnknown:{get:function(){return null===this._isOnline}},forcedOffline:{get:function(){return this._options.forcedOffline},set:function(e){this._options.forcedOffline=e,this._isOnline=null}},clientOnly:{get:function(){return this._options.clientOnly},set:function(e){this._options.clientOnly=e}},pendingRepoName:{get:function(){return this._options.pendingRepoName}},pendingUri:{get:function(){return this._options.pendingUri}},persistenceDisabled:{get:function(){return this._options.persistenceDisabled},set:function(e){this._options.persistenceDisabled=e}},rootUri:{get:function(){return this._options.rootUri},set:function(e){this._options.rootUri=e}},options:{get:function(){return this._options}}}),i.prototype._pkNameGet=function(e){return this.dbService.pkNameGet(e.repoName,e.options)},i.prototype._logMessage=function(e){console.log(e)},i.prototype._pendingRecordsNp=function(e){var t=this.pendingRepoName+(e?"?repoName="+e:"");return this.getNp(t,{rootUri:this.pendingUri,clientOnly:!0})},i.prototype._pendingPostNp=function(e){return this.postNp(this.pendingUri+this.pendingRepoName,e,{rootUri:this.pendingUri,clientOnly:!0})},i.prototype._pendingLengthNp=function(e){var t=this._pendingRecordsNp(e);return t?t.length:0},i.prototype._pendingDeleteNp=function(e){var t=this.pendingRepoName+(e?"/"+e:"");return this.deleteNp(t,{rootUri:this.pendingUri,clientOnly:!0})},i.prototype._pendingClearNp=function(e){var t=this.pendingRepoName+"?repoName="+e;return this.deleteNp(t,{rootUri:this.pendingUri,clientOnly:!0})},i.prototype._pendingAddNp=function(e){var t={id:this._guidGenerate(),restMethod:e.restMethod,resources:e.resources,clientTime:new Date,uri:e.uriFinal,repoName:e.repoName,primaryKey:e.primaryKey};if(e.options.persistenceDisabled)return t;var r=this.dbService.findNp(e.repoName,this._queryAddPk(e,{}));return void 0!==r[0]&&(t.original=JSON.parse(JSON.stringify(r[0]))),this._pendingPostNp(t)},i.prototype._requestGet=function(e){var t=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");return e.options.forcedOffline||e.options.clientOnly?(t.__defineGetter__("readyStateRestOff",function(){return 4}),t.send=function(){this.onreadystatechange()}):t.__defineGetter__("readyStateRestOff",function(){return this.readyState}),t},i.prototype._uriGenerate=function(e){var t=e.uri;-1===t.indexOf("http")&&(t=e.options.rootUri+t);var r=this._autoParams,n=Object.keys(r);if(n.length>0){var o=!0;-1!==t.indexOf("?")?o=!1:t+="?",n.forEach(function(e){t+=(o?"":"&")+e+"="+r[e],o=!1})}return t},i.prototype.uriFromClient=function(e,t,r,n){var o={uri:e,primaryKey:"",restMethod:t,resources:r,options:Object.assign({},this._options,n),searchOptions:{}};o.options.rootUri.endsWith("/")||(o.options.rootUri=o.options.rootUri+"/"),o.uriFinal=this._uriGenerate(o);var i=e.replace(o.options.rootUri,""),s=i.split("?");if(s.length>1){var p=this;i=s[0],o.search=s[1],o.search.split("&").forEach(function(e){var t=e.split("=");2===t.length?o.searchOptions[t[0]]=t[1]:p._logMessage("WARNING: Invalid search query in uri "+o.uriFinal+"'.")})}var a=i.split("/");a.length>1&&(i=a[0],o.primaryKey=a[1]);var u=this._pkNameGet(o);return void 0!==r&&"id"!==u&&"guid"!==u&&(r instanceof Array?r.forEach(function(e){e.id=e[u]}):r.id=r[u]),""===o.primaryKey&&void 0!==r&&null!==r&&void 0!==r[u]&&(o.primaryKey=r[u]),n&&n.repoName?o.repoName=n.repoName:o.repoName=i,"http:"!==o.repoName&&""!==o.repoName||this._logMessage("WARNING: repoName invalid. Had a uri of '"+e+"' and a rootUri of '"+o.options.rootUri+"'' which may be incorrect?"),o},i.prototype.clearAllNp=function(e){e=void 0===e?!1:e;var t=this._pendingLengthNp();if(t>0&&!1===e)throw new Error("Submit pending changes before clearing database or call clearAll(true) to force.");this.dbService.clearAllNp(),this._pendingDeleteNp()},i.prototype.clearAll=function(e){var t=this;return new Promise(function(r,n){e=void 0===e?!1:e;var o=t._pendingLengthNp();o>0&&!1===e?n("Submit pending changes before clearing database or call clearAll(true) to force."):(t.dbService.clearAllNp(),r(t._pendingDeleteNp()))})},i.prototype.clearNp=function(e,t){t=void 0===t?!1:t;var r=this._pendingLengthNp(e);if(r>0&&!1===t)throw new Error("Submit pending changes before clearing database or call clear(repoName, true) to force.");this.dbService.clearNp(e),this._pendingClearNp(e)},i.prototype.clear=function(e,t){var r=this;return new Promise(function(n,o){t=void 0===t?!1:t;var i=r._pendingLengthNp(e);i>0&&!1===t?o("Submit pending changes before clearing database or call clear(repoName, true) to force."):(r.dbService.clearNp(e),n(r._pendingClearNp(e)))})},i.prototype._queryAddPk=function(e,t){return""!==e.primaryKey&&(t[this._pkNameGet(e)]=e.primaryKey),t},i.prototype._queryBuildFromUri=function(e){return this._queryAddPk(e,e.searchOptions)},i.prototype._repoGetNp=function(e){return e.options.persistenceDisabled?[]:this.dbService.findNp(e.repoName,this._queryBuildFromUri(e))},i.prototype._repoGet=function(e){var t=this;return new Promise(function(r){r(e.options.persistenceDisabled?[]:t.dbService.findNp(e.repoName,t._queryBuildFromUri(e)))})},i.prototype._repoFindNp=function(e){return this.dbService.findNp(e.repoName,this._queryAddPk(e,{}))},i.prototype._repoFind=function(e){var t=this;return new Promise(function(r){r(t._repoFindNp(e))})},i.prototype._repoAdd=function(e,t){var r=this;return new Promise(function(n){return e.resources=JSON.parse(t),r._repoAddResource(e).then(function(e){n(e)})})},i.prototype._deepEquals=function(e,t){if("object"==typeof e&&null!==e&&"object"==typeof t&&null!==t){if(Object.keys(e).length!=Object.keys(t).length)return!1;for(var r in e){if(!t.hasOwnProperty(r))return!1;if(!this._deepEquals(e[r],t[r]))return!1}return!0}return e===t},i.prototype._hashify=function(e,t){var r={};return t.forEach(function(t){if(void 0!==t){var n=t[e];r[n]=t}}),r},i.prototype._joinedHash=function(e,t,r){var n={};return t.forEach(function(t){var r=t[e],o={};o.server=t,n[r]=o}),r.forEach(function(t){var r=t[e];if(void 0!==n[r])n[r].client=t;else{var o={};o.client=t,n[r]=o}}),n},i.prototype._applyAndClearPending=function(e){var t=this;return new Promise(function(r,n){return t._restCall(e.uri,e.restMethod,void 0,e.resources).then(function(){r(t._pendingDeleteNp(e.id))})["catch"](function(e){console.log("WARNING! 001 Error %O occured.",e),n(e)})})},i.prototype._forEachHashEntry=function(e,t,r,n,o,i){var s=this;return Object.keys(t).map(function(r){return new Promise(function(n,p){var a=t[r].server,u=t[r].client,c=o[r],d=void 0!==a,l=void 0!==u,f=void 0!==o[r];if(d)if(l){if(f){var h=c?c.original:void 0,y=!s._deepEquals(a,h);if(y){var _=s.options.generateId();return c.primaryKeyOriginal=c.primaryKey,c.primaryKey=_,c.resources[s._pkNameGet(e)]=_,"PUT"===c.restMethod&&(c.restMethod="POST",c.uri=c.uri.replace(c.primaryKeyOriginal,"")),s._applyAndClearPending(c,n,p).then(function(){i.push(c.resources),i.push(a),s.options.onReconciliation&&s.options.onReconciliation(c),n()})}return s._applyAndClearPending(c,n,p).then(function(){n()})}n(i.push(a))}else{if(f)return s._applyAndClearPending(c,n,p).then(function(){n()});n(i.push(a))}else if(l)if(f){if(void 0===c.original)return s._applyAndClearPending(c,n,p).then(function(){n()});s.dbService.deleteNp(e.repoName,s._queryAddPk(e,{})),n(s._pendingDeleteNp(c.id))}else n(s.dbService.deleteNp(e.repoName,s._queryAddPk(e,{})));n("Error: Should not be here. It means the code is not complete.")})})},i.prototype._repoAddResourceNp=function(e){if(!e.options.persistenceDisabled){var t=e.resources instanceof Array?e.resources:[e.resources];return this.dbService.writeNp(e.repoName,t,e.options),e.resources}return e.resources},i.prototype._repoAddResource=function(e){var t=this;return new Promise(function(r){if(!e.options.persistenceDisabled)if(""===e.primaryKey&&"GET"===e.restMethod){var n=e.resources instanceof Array?e.resources:[e.resources],o=t._pendingRecordsNp(e.repoName);if(o.length>0)return t._repoGet(e).then(function(i){var s=[],p=t._pkNameGet(e),a=t._joinedHash(p,n,i),u=t._hashify("primaryKey",o),c=t._forEachHashEntry(e,a,n,i,u,s);return Promise.all(c).then(function(){return t.dbService.writeNp(e.repoName,s),t._pendingClearNp(e.repoName),t._repoGet(e).then(function(e){r(e)})})});t.clearNp(e.repoName),t.dbService.writeNp(e.repoName,n),r(n)}else{var i=e.resources instanceof Array?e.resources:[e.resources];t.dbService.writeNp(e.repoName,i,e.options),r(e.resources)}r(e.resources)})},i.prototype._repoDeleteResourceNp=function(e){return e.options.persistenceDisabled||this.dbService.deleteNp(e.repoName,this._queryAddPk(e,e.searchOptions)),e.primaryKey},i.prototype._createError=function(e,t){var r=e.request,n=r.responseText.replace(/\r?\n|\r/g,""),o=t?t:r.statusText;return 0===r.status&&(o="Network Error"),{message:o,messageDetail:n,status:r.status,uri:e.uriFinal}},i.prototype.autoQueryParamSet=function(e,t){return this._autoParams[e]=t,this},i.prototype.autoQueryParamGet=function(e){return this._autoParams[e]},i.prototype.autoHeaderParamSet=function(e,t){return this._autoHeaders[e]=t,this},i.prototype.autoHeaderParamGet=function(e){return this._autoHeaders[e]},i.prototype._guidGenerate=function(){function e(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()},i.prototype._requestHeaderSet=function(e){var t=this._autoHeaders;Object.keys(t).forEach(function(r){e.setRequestHeader(r,t[r])})},i.prototype._uriAddRequest=function(e,t){return e.request={readyState:t.readyStateRestOff,status:t.status,statusText:t.statusText,response:t.response,responseText:t.responseText},e},i.prototype._dbDeleteNp=function(e){return e.options.clientOnly||this._pendingAddNp(e),this._repoDeleteResourceNp(e)},i.prototype._dbDelete=function(e,t,r){var n=e.request;switch(n.status){case 200:case 202:case 204:this._isOnline=!0,t(this._repoDeleteResourceNp(e));break;case 404:this._isOnline=!0,t(this._repoDeleteResourceNp(e));break;case 0:var o=e.options.clientOnly;e.options.forcedOffline||o?o?t(this._repoDeleteResourceNp(e)):(this._isOnline=!1,this._pendingAddNp(e),t(this._repoDeleteResourceNp(e))):(this._isOnline=null,r(this._createError(e)));break;default:console.log("WARNING: Unsupported HTTP response "+n.status+" for uri '"+e.uriFinal+"'.")}},i.prototype._dbGet=function(e){var t=this;return new Promise(function(r,n){var o=e.request;switch(o.status){case 200:return t._isOnline=!0,t._repoAdd(e,o.response).then(function(e){r(e)});case 0:case 404:var i=e.options.clientOnly;if(e.options.forcedOffline||i)return i||(t._isOnline=!1),t._repoGet(e).then(function(e){r(e)});t._isOnline=0!==o.status?!0:null,n(t._createError(e));break;default:console.log("WARNING: Unsupported HTTP response "+o.status+"."),n()}})},i.prototype._pendingRepoAddNp=function(e){return e.options.clientOnly||this._pendingAddNp(e),this._repoAddResourceNp(e)},i.prototype._pendingRepoAdd=function(e,t,r){if(t)return this._repoAddResource(e).then(function(e){r(e)});var n=this;return this._pendingAddNp(e),n._repoAddResource(e).then(function(e){r(e)})},i.prototype._dbPost=function(e,t,r){var n=e.request;switch(n.status){case 201:return this._isOnline=!0,this._repoAddResource(e).then(function(e){t(e)});case 0:case 404:var o=e.options.clientOnly;e.options.forcedOffline||o?(o||(this._isOnline=!1),this._pendingRepoAdd(e,o,t,r)):(this._isOnline=0!==n.status?!0:null,r(this._createError(e)));break;default:console.log("WARNING: Unsupported HTTP response.")}},i.prototype._dbPutNp=function(e){var t=this._repoFindNp(e);if(t&&0!==t.length)return this._pendingRepoAddNp(e);throw new Error({message:"Not Found",messageDetail:"Not Found",status:404,uri:e.uriFinal})},i.prototype._dbPut=function(e,t,r){var n=e.request;switch(n.status){case 200:this._isOnline=!0,t(this._repoAddResource(e));break;default:this._isOnline=0!==n.status?!0:null;var o=e.options.clientOnly;if(e.options.forcedOffline||o){o||(this._isOnline=!1);var i=this;return this._repoFind(e).then(function(n){return n?i._pendingRepoAdd(e,o,t,r):(e.request.status=404,e.request.statusText="Not Found",r(i._createError(e)),void 0)})}this._isOnline=0!==n.status?!0:null,r(this._createError(e))}},i.prototype._restCall=function(e,t,r,n){var o=this;return new Promise(function(i,s){var p=o.uriFromClient(e,t,n,r),a=o._requestGet(p),u=JSON.stringify(n);a.open(p.restMethod,p.uriFinal,!0),o._requestHeaderSet(a),a.onreadystatechange=function(){if(4===a.readyStateRestOff)switch(o._uriAddRequest(p,a),p.restMethod){case"GET":return o._dbGet(p).then(function(e){i(e)})["catch"](function(e){s(e)});case"POST":o._dbPost(p,i,s);break;case"PUT":o._dbPut(p,i,s);break;case"DELETE":o._dbDelete(p,i,s)}},"POST"===p.restMethod||"PUT"===p.restMethod?(a.setRequestHeader("Content-Type","application/json;charset=UTF-8"),a.send(u)):a.send()})},i.prototype.restCallNp=function(e,t,r,n){var o=r?!!r.clientOnly:!1;if(!this.forcedOffline&&!o)throw new Error(t.toLowerCase()+"Np only available when forcedOffline or clientOnly is true.");var i=this.uriFromClient(e,t,n,r);switch(i.restMethod){case"GET":return this._repoGetNp(i);case"POST":return this._pendingRepoAddNp(i);case"PUT":return this._dbPutNp(i);case"DELETE":return this._dbDeleteNp(i);default:throw new Error("Rest method '"+t+"' not currently supported or is invalid.")}},i.prototype.deleteNp=function(e,t){return this.restCallNp(e,"DELETE",t)},i.prototype.getNp=function(e,t){return this.restCallNp(e,"GET",t)},i.prototype.postNp=function(e,t,r){return this.restCallNp(e,"POST",r,t)},i.prototype.putNp=function(e,t,r){return this.restCallNp(e,"PUT",r,t)},i.prototype["delete"]=function(e,t){return this._restCall(e,"DELETE",t)},i.prototype.get=function(e,t){return this._restCall(e,"GET",t)},i.prototype.post=function(e,t,r){return this._restCall(e,"POST",r,t)},i.prototype.put=function(e,t,r){return this._restCall(e,"PUT",r,t)},p.restoff=o,"undefined"!=typeof angular&&angular.module("restoff",[]).provider("restoff",[function(){var e=null;this.setConfig=function(t){e=t},this.$get=[function(){return new o(e)}]}])}).call(this);