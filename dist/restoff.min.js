(function(){"use strict";function e(e){var r={primaryKeyName:"id",dbName:"restoff.json",repoOptions:[]},n=Object.create(t.prototype);return n._options=Object.assign(r,e),n._dbRepo=o(n._options),n}function t(){}function r(t){var r={rootUri:"",clientOnly:!1,forcedOffline:!1,persistanceDisabled:!1,pendingUri:"http://localhost/",pendingRepoName:"pending"},o=Object.create(n.prototype);return o._options=Object.assign(r,t),o._isOnline=null,o._autoParams={},o._autoHeaders={},o._dbService=e(o._options.dbService),o}function n(){}function o(e){var t={dbName:"restoff.json"},r=Object.create(i.prototype);r._options=Object.assign(t,e);var n=s&&s.low?s.low:void 0;if("undefined"!=typeof module&&module.exports){n=require("lowdb");var o=require("lowdb/file-sync");r._low=n(r.dbName,{storage:o})}else{if("undefined"==typeof n)throw new Error("LowDb library required. Please see README.md on how to get this library.");r._low=n(r.dbName,{storage:n.localStorage})}return r}function i(){}var s=this,a=s.restlib||{};a["version-library"]="0.1.5","undefined"!=typeof module&&module.exports?module.exports=a:s.restlib=a,t.prototype=Object.create(Object.prototype,{dbName:{get:function(){return this.options.dbName},set:function(e){this.options.dbName=e}},dbRepo:{get:function(){return this._dbRepo}},options:{get:function(){return this._options}},primaryKeyName:{get:function(){return this.options.primaryKeyName},set:function(e){this.options.primaryKeyName=e}}}),t.prototype._pkNameGet=function(e,t){var r=this.primaryKeyName,n=this.repoOptionsGet(e);return void 0!==n&&(r=n.primaryKeyName),void 0!==t&&void 0!==t.primaryKeyName&&(r=t.primaryKeyName),r},t.prototype.repoOptionsGet=function(e){var t;return this.options.repoOptions.forEach(function(r){r.repoName===e&&(t=r)}),t},t.prototype.repoOptionsSet=function(e){var t=this;return this.options.repoOptions.forEach(function(r,n){r.repoName===e.repoName&&t.options.repoOptions.splice(n,1)}),this.options.repoOptions.push(e),this},t.prototype.write=function(e,t,r){var n=this;return new Promise(function(o,i){var s=n._pkNameGet(e,r);t=t instanceof Array?t:[t],t.forEach(function(t){var r=t[s];return void 0===r?void i("Primary key '"+s+"' required for resource or the resource has an invalid primary key."):void n.dbRepo.write(e,s,r,t)}),o(t)})},t.prototype.clearAll=function(){var e=this;return new Promise(function(t,r){t(e.dbRepo.clearAll())})},t.prototype.clear=function(e){var t=this;return new Promise(function(r,n){r(t.dbRepo.clear(e))})},t.prototype["delete"]=function(e,t){var r=this;return new Promise(function(n,o){n(r.dbRepo["delete"](e,t))})},t.prototype.find=function(e,t){var r=this;return new Promise(function(n,o){n(r.dbRepo.read(e,t))})},a.restoffService=e,n.prototype=Object.create(Object.prototype,{dbService:{get:function(){return this._dbService}},isStatusOnline:{get:function(){return this._isOnline===!0}},isStatusOffline:{get:function(){return this._isOnline===!1}},isStatusUnknown:{get:function(){return null===this._isOnline}},forcedOffline:{get:function(){return this._options.forcedOffline},set:function(e){this._options.forcedOffline=e,this._isOnline=null}},clientOnly:{get:function(){return this._options.clientOnly},set:function(e){this._options.clientOnly=e}},pendingRepoName:{get:function(){return this._options.pendingRepoName}},pendingUri:{get:function(){return this._options.pendingUri}},persistanceDisabled:{get:function(){return this._options.persistanceDisabled},set:function(e){this._options.persistanceDisabled=e}},primaryKeyName:{get:function(){return this.dbService.primaryKeyName},set:function(e){this.dbService.primaryKeyName=e}},rootUri:{get:function(){return this._options.rootUri},set:function(e){this._options.rootUri=e}},options:{get:function(){return this._options}}}),n.prototype._logMessage=function(e){console.log(e)},n.prototype._pendingRecords=function(e){var t=this.pendingRepoName+(e?"?repoName="+e:"");return this.get(t,{rootUri:this.pendingUri,clientOnly:!0})},n.prototype._pendingLength=function(e){var t=this;return new Promise(function(r,n){var o=t.pendingRepoName+(e?"?repoName="+e:"");return t.get(o,{rootUri:t.pendingUri,clientOnly:!0}).then(function(e){r(e.length)})["catch"](function(e){n(e)})})},n.prototype._requestGet=function(e){var t=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");return e.options.forcedOffline||e.options.clientOnly?(t.__defineGetter__("readyStateRestOff",function(){return t.__proto__.DONE}),t.send=function(){this.onreadystatechange()}):t.__defineGetter__("readyStateRestOff",function(){return this.readyState}),t},n.prototype._uriGenerate=function(e){var t=e.uri;-1===t.indexOf("http")&&(t=e.options.rootUri+t);var r=this._autoParams,n=Object.keys(r);if(n.length>0){var o=!0;-1!==t.indexOf("?")?o=!1:t+="?",n.forEach(function(e){t+=(o?"":"&")+e+"="+r[e],o=!1})}return t},n.prototype.uriFromClient=function(e,t,r,n){var o={uri:e,primaryKey:"",primaryKeyName:this.primaryKeyName,restMethod:t,resources:r,options:Object.assign({},this._options,n),searchOptions:{}};o.options.rootUri.endsWith("/")||(o.options.rootUri=o.options.rootUri+"/"),o.uriFinal=this._uriGenerate(o);var i=e.replace(o.options.rootUri,""),s=i.split("?");if(s.length>1){var a=this;i=s[0],o.search=s[1],o.search.split("&").forEach(function(e){var t=e.split("=");2===t.length?o.searchOptions[t[0]]=t[1]:a._logMessage("WARNING: Invalid search query in uri "+o.uriFinal+"'.")})}var u=i.split("/");return u.length>1&&(i=u[0],o.primaryKey=u[1]),""===o.primaryKey&&void 0!==r&&null!==r&&void 0!==r[this.primaryKeyName]&&(o.primaryKey=r[this.primaryKeyName]),o.repoName=i,"http:"!==o.repoName&&""!==o.repoName||this._logMessage("WARNING: repoName invalid. Had a uri of '"+e+"' and a rootUri of '"+o.options.rootUri+"'' which may be incorrect?"),o},n.prototype._pendingDelete=function(e){return this["delete"](this.pendingRepoName+"/"+e,{rootUri:this.pendingUri,clientOnly:!0})},n.prototype.clearAll=function(e){var t=this;return new Promise(function(r,n){return e=void 0===e?!1:e,t._pendingLength().then(function(o){return o>0&&!1===e?void n("Submit pending changes before clearing database or call clearAll(true) to force."):t.dbService.clearAll().then(function(){return t["delete"](t.pendingRepoName,{rootUri:t.pendingUri,clientOnly:!0}).then(function(e){r()})["catch"](function(e){n(e)})})})})},n.prototype.clear=function(e,t){var r=this;return new Promise(function(n,o){return t=void 0===t?!1:t,r._pendingLength(e).then(function(i){return i>0&&!1===t?void o("Submit pending changes before clearing database or call clear(repoName, true) to force."):r.dbService.clear(e).then(function(t){return r["delete"](r.pendingRepoName+"?repoName="+e,{rootUri:r.pendingUri,clientOnly:!0}).then(function(e){n()})["catch"](function(e){o(e)})})})})},n.prototype._repoGet=function(e){var t=this;return new Promise(function(r,n){var o=e.searchOptions;return""!==e.primaryKey&&(o[e.primaryKeyName]=e.primaryKey),e.options.persistanceDisabled?void r([]):t.dbService.find(e.repoName,o).then(function(e){r(e)})})},n.prototype._repoFind=function(e){var t=this;return new Promise(function(r,n){var o={};return o[e.keyName]=e.primaryKey,t.dbService.find(e.repoName,o).then(function(e){r(e)})})},n.prototype._repoAdd=function(e,t){var r=this;return new Promise(function(n,o){return e.resources=JSON.parse(t),r._repoAddResource(e).then(function(e){n(e)})})},n.prototype._findBy=function(e,t){return e.filter(function(e){return e.id===t})[0]},n.prototype._deepEquals=function(e,t){if("object"==typeof e&&null!=e&&"object"==typeof t&&null!=t){if(Object.keys(e).length!=Object.keys(t).length)return!1;for(var r in e){if(!t.hasOwnProperty(r))return!1;if(!this._deepEquals(e[r],t[r]))return!1}return!0}return e===t},n.prototype._hashify=function(e,t){var r={};return t.forEach(function(t){if(void 0!==t){var n=t[e];r[n]=t}}),r},n.prototype._joinedHash=function(e,t,r){var n={};return t.forEach(function(t){var r=t[e],o={};o.server=t,n[r]=o}),r.forEach(function(t){var r=t[e];if(void 0!==n[r])n[r].client=t;else{var o={};o.client=t,n[r]=o}}),n},n.prototype._applyAndClearPending=function(e,t,r){var n=this;return n._restCall(e.uri,e.restMethod,void 0,e.resources).then(function(o){return n._pendingDelete(e.id).then(function(e){t(void 0)})["catch"](function(e){console.log("WARNING! 002 Error %O occured.",e),r(e)})})["catch"](function(e){console.log("WARNING! 001 Error %O occured.",e),r(e)})},n.prototype._forEachHashEntry=function(e,t,r,n,o,i){var s=this;return Object.keys(t).map(function(r){return new Promise(function(n,a){var u=t[r].server,p=t[r].client,c=o[r],f=void 0!==u,d=void 0!==p,l=void 0!==o[r];if(f)if(d)if(l){var h=c?c.original:void 0,y=!s._deepEquals(u,h);if(!y)return s._applyAndClearPending(c,n,a);console.log(r+" TODO: 10 Add test")}else n(i.push(u));else{if(l)return s._applyAndClearPending(c,n,a);console.log(r+" TODO: 04 Add test")}else if(d){if(l){if(void 0===c.original)return s._applyAndClearPending(c,n,a);var _={};return _[s.primaryKeyName]=r,s.dbService["delete"](e,_).then(function(e){return s._pendingDelete(c.id).then(function(e){n(void 0)})["catch"](function(e){console.log("WARNING! 002 Error %O occured.",e),a(e)})})}console.log(r+" TODO: 06 Add test")}else l&&console.log(r+" TODO: 07 Add test");n("Error: Should not be here or code is not complete.")})})},n.prototype._repoAddResource=function(e){var t=this;return new Promise(function(r,n){if(!e.options.persistanceDisabled){if(""===e.primaryKey&&"GET"===e.restMethod){var o=e.resources instanceof Array?e.resources:[e.resources];return t._pendingRecords(e.repoName).then(function(n){return n.length>0?t._repoGet(e).then(function(i){var s=[],a=t._joinedHash(t.primaryKeyName,o,i),u=t._hashify("primaryKey",n),p=t._forEachHashEntry(e.repoName,a,o,i,u,s);return Promise.all(p).then(function(n){return t.dbService.write(e.repoName,s).then(function(n){return t._repoGet(e).then(function(e){r(e)})})})}):t.clear(e.repoName).then(function(){return t.dbService.write(e.repoName,o).then(function(e){r(o)})})})}var i=e.resources instanceof Array?e.resources:[e.resources];return t.dbService.write(e.repoName,i).then(function(t){r(e.resources)})}r(e.resources)})},n.prototype._repoDeleteResource=function(e,t){if(!e.options.persistanceDisabled){var r=e.searchOptions;return""!==e.primaryKey&&(r[e.primaryKeyName]=e.primaryKey),this.dbService["delete"](e.repoName,r).then(function(r){t(e.primaryKey)})}t(e.primaryKey)},n.prototype._createError=function(e){var t=e.request,r=t.responseText.replace(/\r?\n|\r/g,""),n=t.statusText;return 0===t.status&&(n="Network Error"),{message:n,messageDetail:r,status:t.status,uri:e.uriFinal}},n.prototype.autoQueryParamSet=function(e,t){return this._autoParams[e]=t,this},n.prototype.autoQueryParamGet=function(e){return this._autoParams[e]},n.prototype.autoHeaderParamSet=function(e,t){return this._autoHeaders[e]=t,this},n.prototype.autoHeaderParamGet=function(e){return this._autoHeaders[e]},n.prototype._guid=function(){function e(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()},n.prototype._pendingAdd=function(e){var t=this;return new Promise(function(r,n){var o={id:t._guid(),restMethod:e.restMethod,resources:e.resources,clientTime:new Date,uri:e.uriFinal,repoName:e.repoName,primaryKey:e.primaryKey};if(!e.options.persistanceDisabled){var i={};return i[t.primaryKeyName]=e.primaryKey,t.dbService.find(e.repoName,i).then(function(e){return void 0!==e[0]&&(o.original=JSON.parse(JSON.stringify(e[0]))),t.post(t.pendingUri+t.pendingRepoName,o,{rootUri:t.pendingUri,clientOnly:!0}).then(function(e){r(e)})["catch"](function(e){n(e)})})}r(o)})},n.prototype._requestHeaderSet=function(e){var t=this._autoHeaders;Object.keys(t).forEach(function(r){e.setRequestHeader(r,t[r])})},n.prototype._uriAddRequest=function(e,t){return e.request={readyState:t.readyStateRestOff,status:t.status,statusText:t.statusText,response:t.response,responseText:t.responseText},e},n.prototype._dbDelete=function(e,t,r){var n=e.request;switch(n.status){case 200:case 202:case 204:this._isOnline=!0,this._repoDeleteResource(e,t);break;case 404:this._isOnline=!0,this._repoDeleteResource(e,t);break;case 0:var o=e.options.clientOnly;if(e.options.forcedOffline||o)if(o)this._repoDeleteResource(e,t);else{var i=this;this._isOnline=!1,this._pendingAdd(e).then(function(r){i._repoDeleteResource(e,t)})}else this._isOnline=null,r(this._createError(e));break;default:console.log("WARNING: Unsupported HTTP response.")}},n.prototype._dbGet=function(e){var t=this;return new Promise(function(r,n){var o=e.request;switch(o.status){case 200:return t._isOnline=!0,t._repoAdd(e,o.response).then(function(e){r(e)});case 0:case 404:var i=e.options.clientOnly;if(e.options.forcedOffline||i)return i||(t._isOnline=!1),t._repoGet(e).then(function(e){r(e)});t._isOnline=0!==o.status?!0:null,n(t._createError(e));break;default:console.log("WARNING: Unsupported HTTP response."),n()}})},n.prototype._pendingRepoAdd=function(e,t,r,n){if(t)return this._repoAddResource(e).then(function(e){r(e)});var o=this;return this._pendingAdd(e).then(function(t){return o._repoAddResource(e).then(function(e){r(e)})})},n.prototype._dbPost=function(e,t,r){var n=e.request;switch(n.status){case 201:return this._isOnline=!0,this._repoAddResource(e).then(function(e){t(e)});case 0:case 404:var o=e.options.clientOnly;e.options.forcedOffline||o?(o||(this._isOnline=!1),this._pendingRepoAdd(e,o,t,r)):(this._isOnline=0!==n.status?!0:null,r(this._createError(e)));break;default:console.log("WARNING: Unsupported HTTP response.")}},n.prototype._dbPut=function(e,t,r){var n=e.request;switch(n.status){case 200:this._isOnline=!0,t(this._repoAddResource(e));break;default:n.status,n.statusText;this._isOnline=0!==n.status?!0:null;var o=e.options.clientOnly;if(e.options.forcedOffline||o){o||(this._isOnline=!1);var i=this;return this._repoFind(e).then(function(n){return n?i._pendingRepoAdd(e,o,t,r):(e.request.status=404,e.request.statusText="Not Found",r(i._createError(e)),void 0)})}this._isOnline=0!==n.status?!0:null,r(this._createError(e))}},n.prototype._restCall=function(e,t,r,n){var o=this;return new Promise(function(i,s){var a=o.uriFromClient(e,t,n,r),u=o._requestGet(a),p=JSON.stringify(n);u.open(a.restMethod,a.uriFinal,!0),o._requestHeaderSet(u),u.onreadystatechange=function(){if(4===u.readyStateRestOff)switch(o._uriAddRequest(a,u),a.restMethod){case"GET":return o._dbGet(a).then(function(e){i(e)})["catch"](function(e){s(e)});case"POST":o._dbPost(a,i,s);break;case"PUT":o._dbPut(a,i,s);break;case"DELETE":o._dbDelete(a,i,s)}},"POST"===a.restMethod||"PUT"===a.restMethod?(u.setRequestHeader("Content-Type","application/json;charset=UTF-8"),u.send(p)):u.send()})},n.prototype["delete"]=function(e,t){return this._restCall(e,"DELETE",t)},n.prototype.get=function(e,t){return this._restCall(e,"GET",t)},n.prototype.post=function(e,t,r){return this._restCall(e,"POST",r,t)},n.prototype.put=function(e,t,r){return this._restCall(e,"PUT",r,t)},a.restoff=r,i.prototype=Object.create(Object.prototype,{dbName:{get:function(){return this.options.dbName},set:function(e){this.options.dbName=e}},dbEngine:{get:function(){return this._low}},options:{get:function(){return this._options}}}),a.lowdbRepo=o,i.prototype.length=function(e){return this._low(e).size()},i.prototype.clear=function(e){delete this._low.object[e],this._low.write()},i.prototype.clearAll=function(){this._low.object={},this._low.write()},i.prototype.find=function(e,t,r){var n={};return n[t]=r,this._low(e).find(n)},i.prototype.read=function(e,t){return this._low(e).chain().filter(t).value()},i.prototype.write=function(e,t,r,n){if(void 0===this.find(e,t,r))this._low(e).push(n);else{var o={};o[t]=r,this.dbEngine(e).chain().find(o).assign(n).value()}},i.prototype["delete"]=function(e,t){this._low(e).remove(t)}}).call(this);