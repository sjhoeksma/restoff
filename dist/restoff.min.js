(function(){"use strict";function e(e){var n=Object.create(t.prototype);return n._isOnline=null,n._forcedOffline=!1,n._persistanceDisabled=void 0!==e&&e.persistanceDisabled?e.persistanceDisabled:!1,n._persistanceDisabled?n._dbRepo=null:n._dbRepo=void 0!==e&&e.dbRepo?e.dbRepo:r(),n._autoParams={},n._autoHeaders={},n._pending=[],n._rootUri=void 0!==e&&e.rootUri?e.rootUri:"",n._primaryKeyName=void 0!==e&&e.primaryKeyName?e.primaryKeyName:"id",n}function t(){}function r(e){var t=Object.create(n.prototype);return t._dbName=void 0!==e&&e.dbName?e.dbName:"restoff",t._low=low(t._dbName,{storage:low.localStorage}),t}function n(){}var o=this,i=o.restlib||{};i["version-library"]="0.0.19","undefined"!=typeof module&&module.exports?module.exports=i:o.restlib=i,t.prototype=Object.create(Object.prototype,{dbRepo:{get:function(){return this._dbRepo}},pending:{get:function(){return this._pending}},isStatusOnline:{get:function(){return this._isOnline===!0}},isStatusOffline:{get:function(){return this._isOnline===!1}},isStatusUnknown:{get:function(){return null===this._isOnline}},isForcedOffline:{get:function(){return this._forcedOffline}},persistanceDisabled:{get:function(){return this._persistanceDisabled},set:function(e){this._persistanceDisabled=e,this._dbRepo=e?null:r()}},primaryKeyName:{get:function(){return this._primaryKeyName},set:function(e){this._primaryKeyName=e}},rootUri:{get:function(){return this._rootUri},set:function(e){this._rootUri=e}},getRequest:{get:function(){var e=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP");return this.isForcedOffline?(e.__defineGetter__("readyState2",function(){return e.__proto__.DONE}),e.send=function(){this.onreadystatechange()}):e.__defineGetter__("readyState2",function(){return this.readyState}),e}},deleteSomeTime:{get:function(){return this._isOnline===!0}}}),t.prototype.clearAll=function(e){if(e=void 0===e?!1:e,this.pending.length>0&&!1===e)throw new Error("Submit pending changes before clearing database or call clearAll(true) to force.");this._dbRepo.clearAll(),this._pending=[]},t.prototype.clear=function(e,t){if(t=void 0===t?!1:t,this.pending.length>0&&!1===t)throw new Error("Submit pending changes before clearing database or call clear(repoName, true) to force.");this._dbRepo.clear(e),this._pending.forEach(function(t,r,n){e===t.repoName&&n.splice(r,1)})},t.prototype.uriGenerate=function(e){var t=e;-1===t.indexOf("http")&&(t=this.rootUri+t);var r=this._autoParams,n=Object.keys(r);if(n.length>0){var o=!0;-1!==t.indexOf("?")?o=!1:t+="?",n.forEach(function(e){t+=(o?"":"&")+e+"="+r[e],o=!1})}return t},t.prototype.forceOffline=function(e){return this._forcedOffline=!0,this._isOnline=null,this},t.prototype.primaryKeyFor=function(e){var t=e[this.primaryKeyName];return void 0===e[this.primaryKeyName]&&console.log("Warning: resource did not have a primaryKey "+t),t},t.prototype.repoAdd=function(e,t){var r=JSON.parse(t);return this.repoAddResource(e,r)},t.prototype.repoGet=function(e){return this.persistanceDisabled?[]:this.dbRepo.read(this.repoNameFrom(e))},t.prototype.repoAddResource=function(e,t){if(!this.persistanceDisabled){var r=this,n=this.repoNameFrom(e);if(t instanceof Array)t.forEach(function(e){var t=r.primaryKeyFor(e);r.dbRepo.write(n,r.primaryKeyName,t,e)});else{var o=this.primaryKeyFor(t);r.dbRepo.write(n,r.primaryKeyName,o,t)}}return t},t.prototype.repoNameFrom=function(e){var t=e.replace(this.rootUri,""),r=t.split("/");return r.length>1&&(t=r[0]),t},t.prototype.createError=function(e,t,r,n){var o=e.responseText.replace(/\r?\n|\r/g,"");return 0===r&&(n="Network Error"),{message:n,messageDetail:o,status:r,uri:t}},t.prototype.autoQueryParamSet=function(e,t){return this._autoParams[e]=t,this},t.prototype.autoQueryParamGet=function(e){return this._autoParams[e]},t.prototype.autoHeaderParamSet=function(e,t){return this._autoHeaders[e]=t,this},t.prototype.autoHeaderParamGet=function(e){return this._autoHeaders[e]},t.prototype.pendingAdd=function(e,t,r){var n={restCall:r,resource:t,clientTime:new Date,uri:e,repoName:this.repoNameFrom(e)};return this._pending.push(n),n},t.prototype.get=function(e){var t=this,r=new Promise(function(r,n){var o=t.getRequest,i=t.uriGenerate(e);o.open("GET",i,!0);var s=t._autoHeaders;Object.keys(s).forEach(function(e){o.setRequestHeader(e,s[e])}),o.onreadystatechange=function(){o.__proto__.DONE===o.readyState2&&(o.__proto__.UNSENT===o.status&&t.isForcedOffline?(t._isOnline=!1,r(t.repoGet(i))):200===o.status?(t._isOnline=!0,r(t.repoAdd(i,o.response))):(t._isOnline=0!==o.status?!0:null,n(t.createError(o,i,o.status,o.statusText))))},o.send()});return r},t.prototype.post=function(e,t){var r=this,n=new Promise(function(n,o){var i=r.getRequest,s=r.uriGenerate(e),a=JSON.stringify(t);i.open("POST",s,!0),i.onreadystatechange=function(){i.__proto__.DONE===i.readyState2&&(i.__proto__.UNSENT===i.status&&r.isForcedOffline?(r._isOnline=!1,r.pendingAdd(s,t,"POST"),n(r.repoAddResource(s,t))):201===i.status?(r._isOnline=!0,n(r.repoAddResource(s,t))):(r._isOnline=0!==i.status?!0:null,o(r.createError(i,s,i.status,i.statusText))))},i.setRequestHeader("Content-Type","application/json;charset=UTF-8"),i.send(a)});return n},t.prototype.put=function(e,t){var r=this,n=new Promise(function(n,o){var i=r.getRequest,s=r.uriGenerate(e),a=JSON.stringify(t);i.open("PUT",s,!0),i.onreadystatechange=function(){if(i.__proto__.DONE===i.readyState2)if(200===i.status)r._isOnline=!0,n(r.repoAddResource(s,t));else{var e=i.status,a=i.statusText;if(r._isOnline=0!==i.status?!0:null,r.isForcedOffline){var u=r.repoNameFrom(s),p=r.primaryKeyFor(t);r._dbRepo.find(u,r.primaryKeyName,p)?(r.pendingAdd(s,t,"PUT"),n(r.repoAddResource(s,t))):(e=404,a="Not Found",o(r.createError(i,s,e,a)))}else o(r.createError(i,s,i.status,i.statusText))}},i.setRequestHeader("Content-Type","application/json;charset=UTF-8"),i.send(a)});return n},i.restoff=e,n.prototype=Object.create(Object.prototype,{dbName:{get:function(){return this._dbName},set:function(e){this._dbName=e}},dbEngine:{get:function(){return this._low}},deleteSomeTime:{get:function(){return this._isOnline===!0}}}),i.lowdbRepo=r,n.prototype.length=function(e){return this._low(e).size()},n.prototype.clear=function(e){delete this._low.object[e],this._low.write()},n.prototype.clearAll=function(){this._low.object={},this._low.write()},n.prototype.find=function(e,t,r){var n={};return n[t]=r,this._low(e).find(n)},n.prototype.read=function(e){return this._low(e).value()},n.prototype.write=function(e,t,r,n){if(void 0===this.find(e,t,r))this._low(e).push(n);else{var o={};o[t]=r,this.dbEngine(e).chain().find(o).assign(n).value()}}}).call(this);